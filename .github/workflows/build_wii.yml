name: Libspectrum for WII
run-name: Build and test Libspectrum for WII [ +fake glib, -zlib, -bzip2, -libaudiofile, -libgcrypt ] / ${{ github.actor }} /
on: [push]
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container: devkitpro/devkitppc
    steps:
      - name: (1) Check out repository code
        uses: actions/checkout@v3

      - name: (2) Install dependencies
        run: |
          echo "Installing dependencies .."
          echo "Using devkitpro/devkitppc image"
          sudo apt-get update
          sudo apt-get -y install --no-install-recommends \
            wget tar autoconf automake libtool && \
          sudo rm -rf /var/lib/apt/lists/*
          echo "Done."
          
        shell: bash

      - name: (3) Autogen.sh
        run: |
          echo "Running autogen.sh .."
          ./autogen.sh
        shell: bash

      - name: (4) Configure for WII (fake glib)
        run: |
          echo "Running configure for WII .."
          ./configure --target=powerpc-eabi --host=powerpc-eabi \
            --prefix=$DEVKITPPC \
            --without-libgcrypt --with-fake-glib --without-libaudiofile \
            | tee ./configure.out
        shell: bash

      - name: (5) Verify output from configure
        run: |
          .github/scripts/in_config.sh "libspectrum is ready to be compiled"
          .github/scripts/in_config.sh "zlib support: yes"
          .github/scripts/in_config.sh "bzip2 support: yes"
          .github/scripts/in_config.sh "libgcrypt support: no"
          .github/scripts/in_config.sh "libaudiofile support: no"
          .github/scripts/in_config.sh "Internal GLib replacement: yes"
        shell: bash

      - name: (6) Make
        run: |
          echo "Running make .."
          make
        shell: bash

      - name: (7) Install (+sudo)
        run: |
          echo "Running make install .."
          sudo make install
        shell: bash

      - name: (8) Run tests
        run: |
          echo "Bulding and running tests .."
          ## make check  <-- cross compiled, cannot execute under Linux
          echo "FIXME: make check not possible, cross compiled."
        shell: bash

      - name: (10) Upload generated files
        uses: actions/upload-artifact@v3
        with: 
          name: libspectrum-wii
          path: |
            doc/libspectrum.3
            libspectrum.h
            libspectrum.pc

      - name: (10) Finish
        run: |
          echo "ðŸ Finishing with status ${{ job.status }}."
